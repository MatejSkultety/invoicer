# ===========================================
# YAML ANCHORS FOR COMMON CONFIGURATIONS
# ===========================================

x-common: &common-config
  restart: unless-stopped

x-base-service: &base-service
  profiles: ["all", "essential"]
  networks:
    - main-network

x-app-build: &app-build
  context: ./
  args:
    DOCKER_BUILDKIT: 1

x-timezone: &timezone
  TZ: Europe/Bratislava

x-debug-env: &debug-env
  DEBUG_MODE: 1
  GUEST_MODE: 1

# ===========================================
# SERVICES
# ===========================================

services:

  # ===========================================
  # CORE APPLICATION SERVICES
  # ===========================================

  # Backend Service
  backend:
    <<: [*common-config, *base-service]
    build:
      <<: *app-build
      dockerfile: ./backend/Dockerfile
    image: invoicer-backend:latest
    container_name: invoicer-backend
    environment:
      <<: [*timezone, *debug-env]
    expose:
      - "8080"
    networks:
      - main-network

  # Frontend Application (Vue.js)
  frontend:
    <<: [*common-config, *base-service]
    build:
      <<: *app-build
      dockerfile: ./frontend/Dockerfile
    image: invoicer-frontend:latest
    container_name: invoicer-frontend
    depends_on:
      backend:
        condition: service_started
    environment:
      <<: [*timezone, *debug-env]
    expose:
      - "3000"
    networks:
      - main-network

  # Reverse Proxy
  reverse-proxy:
    <<: [*common-config, *base-service]
    build:
      context: ./nginx
      dockerfile: Dockerfile
    image: invoicer-nginx:latest
    container_name: invoicer-reverse-proxy
    depends_on:
      frontend:
        condition: service_started
      backend:
        condition: service_started
    ports:
      - "80:80"      # frontend only - backend is internal!
    networks:
      - main-network

# ===========================================
# NETWORKS
# ===========================================

networks:
  main-network:
    driver: bridge